<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if and .Title (not .IsHome) }}{{ .Title }} - {{ end }}{{ .Site.Title }}</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
    <script>
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <div class="container">
        <header class="site-header">
            <a href="/" class="site-title">Aron Vallinder</a>
            <div class="header-row">
                <nav class="site-nav">
                    <a href="/"{{ if .IsHome }} class="active"{{ end }}>About</a>
                    <a href="/papers/"{{ if eq .RelPermalink "/papers/" }} class="active"{{ end }}>Papers</a>
                    <a href="/blog/"{{ if or (eq .Section "blog") (eq .RelPermalink "/blog/") }} class="active"{{ end }}>Notes</a>
                </nav>
                <div class="header-controls">
                    <input type="text" id="search-input" placeholder="search" autocomplete="off">
                    <div id="search-results"></div>
                    <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">dark</button>
                </div>
            </div>
        </header>
        <main>
            {{ block "main" . }}{{ end }}
        </main>
        <footer class="site-footer">
            <div class="footer-links">
                <a href="mailto:vallinder@gmail.com">Email</a>
                <a href="https://scholar.google.com/citations?user=f1rBCmgAAAAJ&hl=en" target="_blank" rel="noopener">Google Scholar</a>
                <a href="https://x.com/aronvallinder" target="_blank" rel="noopener">Twitter</a>
                <a href="/index.xml">RSS</a>
            </div>
            <p class="footer-copy">&copy; {{ now.Year }} Aron Vallinder</p>
        </footer>
    </div>
    <script>
        // Dark mode toggle
        const themeToggle = document.getElementById('theme-toggle');
        function updateToggleText() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            themeToggle.textContent = isDark ? 'light' : 'dark';
        }
        updateToggleText();

        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            updateToggleText();
        });

        // Search functionality
        let searchIndex = null;
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');

        async function loadSearchIndex() {
            if (!searchIndex) {
                const response = await fetch('/index.json');
                searchIndex = await response.json();
            }
            return searchIndex;
        }

        searchInput.addEventListener('focus', loadSearchIndex);

        searchInput.addEventListener('input', async function() {
            const query = this.value.toLowerCase().trim();
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            const index = await loadSearchIndex();
            const results = index.filter(item =>
                item.title.toLowerCase().includes(query) ||
                item.content.toLowerCase().includes(query)
            ).slice(0, 5);

            if (results.length > 0) {
                searchResults.innerHTML = results.map(r =>
                    `<a href="${r.url}">${r.title}</a>`
                ).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<span class="no-results">No results</span>';
                searchResults.style.display = 'block';
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.header-controls')) {
                searchResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>

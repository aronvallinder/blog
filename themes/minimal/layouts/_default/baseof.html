<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} - {{ end }}{{ .Site.Title }}</title>
    <link rel="stylesheet" href="/css/style.css">
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <div class="progress-bar" id="progress"></div>
    <div class="container">
        <header class="site-header">
            <a href="/" class="site-title">
                <svg class="site-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="5" cy="6" r="3"/>
                    <circle cx="19" cy="6" r="3"/>
                    <circle cx="12" cy="18" r="3"/>
                    <line x1="7.5" y1="7.5" x2="10.5" y2="15.5"/>
                    <line x1="16.5" y1="7.5" x2="13.5" y2="15.5"/>
                    <line x1="8" y1="6" x2="16" y2="6"/>
                </svg>
                Aron Vallinder
            </a>
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="[search]" autocomplete="off">
                <div id="search-results"></div>
            </div>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">[dark]</button>
        </header>
        <nav class="site-nav">
            <div class="nav-links">
                <a href="/"{{ if .IsHome }} class="active"{{ end }}>About</a>
                <a href="/papers/"{{ if eq .RelPermalink "/papers/" }} class="active"{{ end }}>Papers</a>
                <a href="/blog/"{{ if or (eq .Section "blog") (eq .RelPermalink "/blog/") }} class="active"{{ end }}>Blog</a>
            </div>
        </nav>
        <main>
            {{ block "main" . }}{{ end }}
        </main>
        <footer class="site-footer">
            <div class="footer-links">
                <a href="mailto:vallinder@gmail.com">Email</a>
                <a href="/archive/">Archive</a>
            </div>
            <p class="footer-copy">Â© {{ now.Year }} Aron Vallinder</p>
        </footer>
    </div>
    <script>
        // Reading progress bar
        window.addEventListener('scroll', function() {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById('progress').style.width = scrolled + '%';
        });

        // Dark mode toggle
        const themeToggle = document.getElementById('theme-toggle');
        function updateToggleText() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            themeToggle.textContent = isDark ? '[light]' : '[dark]';
        }
        updateToggleText();

        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            updateToggleText();
        });

        // Search functionality
        let searchIndex = null;
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');

        async function loadSearchIndex() {
            if (!searchIndex) {
                const response = await fetch('/index.json');
                searchIndex = await response.json();
            }
            return searchIndex;
        }

        searchInput.addEventListener('focus', loadSearchIndex);

        searchInput.addEventListener('input', async function() {
            const query = this.value.toLowerCase().trim();
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            const index = await loadSearchIndex();
            const results = index.filter(item =>
                item.title.toLowerCase().includes(query) ||
                item.content.toLowerCase().includes(query)
            ).slice(0, 5);

            if (results.length > 0) {
                searchResults.innerHTML = results.map(r =>
                    `<a href="${r.url}">${r.title}</a>`
                ).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<span class="no-results">No results</span>';
                searchResults.style.display = 'block';
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>

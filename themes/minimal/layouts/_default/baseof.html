<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ if .Title }}{{ .Title }} - {{ end }}{{ .Site.Title }}</title>
    <link rel="stylesheet" href="/css/style.css">
    <script>
        // Apply saved theme immediately to prevent flash
        (function() {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <div class="progress-bar" id="progress"></div>
    <div class="container">
        <header class="site-header">
            <a href="/" class="site-title">
                <svg class="site-icon" width="32" height="20" viewBox="0 0 32 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <path d="M8 10 C8 8, 10 8, 10 10 C10 13, 5 13, 5 10 C5 5, 13 5, 13 10 C13 16, 2 16, 2 10 C2 3, 15 3, 15 10"/>
                    <path d="M24 10 C24 8, 22 8, 22 10 C22 13, 27 13, 27 10 C27 5, 19 5, 19 10 C19 16, 30 16, 30 10 C30 3, 17 3, 17 10"/>
                </svg>
                Aron Vallinder
            </a>
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="[search]" autocomplete="off">
                <div id="search-results"></div>
            </div>
            <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark mode">[dark]</button>
        </header>
        <nav class="site-nav">
            <div class="nav-links">
                <a href="/"{{ if .IsHome }} class="active"{{ end }}>About</a>
                <a href="/papers/"{{ if eq .RelPermalink "/papers/" }} class="active"{{ end }}>Papers</a>
                <a href="/blog/"{{ if or (eq .Section "blog") (eq .RelPermalink "/blog/") }} class="active"{{ end }}>Blog</a>
            </div>
        </nav>
        <main>
            {{ block "main" . }}{{ end }}
        </main>
        <footer class="site-footer">
            <div class="footer-links">
                <a href="mailto:vallinder@gmail.com">Email</a>
                <a href="/archive/">Archive</a>
            </div>
            <p class="footer-copy">Â© {{ now.Year }} Aron Vallinder</p>
        </footer>
    </div>
    <script>
        // Reading progress bar
        window.addEventListener('scroll', function() {
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById('progress').style.width = scrolled + '%';
        });

        // Dark mode toggle
        const themeToggle = document.getElementById('theme-toggle');
        function updateToggleText() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            themeToggle.textContent = isDark ? '[light]' : '[dark]';
        }
        updateToggleText();

        themeToggle.addEventListener('click', function() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
            updateToggleText();
        });

        // Search functionality
        let searchIndex = null;
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');

        async function loadSearchIndex() {
            if (!searchIndex) {
                const response = await fetch('/index.json');
                searchIndex = await response.json();
            }
            return searchIndex;
        }

        searchInput.addEventListener('focus', loadSearchIndex);

        searchInput.addEventListener('input', async function() {
            const query = this.value.toLowerCase().trim();
            if (query.length < 2) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            const index = await loadSearchIndex();
            const results = index.filter(item =>
                item.title.toLowerCase().includes(query) ||
                item.content.toLowerCase().includes(query)
            ).slice(0, 5);

            if (results.length > 0) {
                searchResults.innerHTML = results.map(r =>
                    `<a href="${r.url}">${r.title}</a>`
                ).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.innerHTML = '<span class="no-results">No results</span>';
                searchResults.style.display = 'block';
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-wrapper')) {
                searchResults.style.display = 'none';
            }
        });
    </script>
</body>
</html>
